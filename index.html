<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: #1f2937; }
        #chat-window::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .form-input { background-color: #1a202c; border: 1px solid #4a5568; color: #e2e8f0; border-radius: 0.5rem; padding: 0.5rem 1rem; width: 100%; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        #detailed-analysis-form.hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">
    <main class="bg-gray-800 text-white rounded-xl shadow-2xl w-full max-w-2xl h-[90vh] max-h-[800px] flex flex-col border border-gray-700">
        <header class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold text-center text-blue-400">Fraud Detection Assistant</h1>
        </header>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-4">
            <div class="bot-message self-start max-w-md">
                <div class="bg-gray-700 rounded-lg p-3">
                    <p>Hello! Paste a message for a quick NLP analysis, or expand the section below to enter full transaction details for a hybrid analysis.</p>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div class="p-4 border-y border-gray-700 bg-gray-800">
            <button id="toggle-details-btn" class="w-full text-left font-semibold text-blue-400 hover:text-blue-300">
                Enter Full Transaction Details for Hybrid Analysis &#9662;
            </button>
            <form id="detailed-analysis-form" class="hidden mt-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="number" id="step" class="form-input" placeholder="Step (e.g., 1)">
                    <select id="type" class="form-input bg-gray-800"><option value="TRANSFER">TRANSFER</option><option value="CASH_OUT">CASH_OUT</option><option value="PAYMENT">PAYMENT</option></select>
                    <input type="number" step="0.01" id="amount" class="form-input" placeholder="Amount (e.g., 180.50)">
                    <input type="number" step="0.01" id="oldbalanceOrg" class="form-input" placeholder="Sender's old balance">
                    <input type="number" step="0.01" id="newbalanceOrig" class="form-input" placeholder="Sender's new balance">
                    <input type="number" step="0.01" id="oldbalanceDest" class="form-input" placeholder="Recipient's old balance">
                </div>
                <!-- The new text box for hybrid analysis -->
                <div>
                    <textarea id="hybrid-text-message" class="form-input" rows="2" placeholder="Enter transaction message (optional)..."></textarea>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Analyze Full Transaction</button>
            </form>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden p-4"><div class="bg-gray-700 rounded-lg p-3 inline-flex items-center"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>

        <!-- Chat Input Form -->
        <footer class="p-4">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="chat-input" class="flex-1 bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 rounded-lg p-3" placeholder="Type a message for quick analysis..." autocomplete="off">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg></button>
            </form>
        </footer>
    </main>
    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const detailedForm = document.getElementById('detailed-analysis-form');
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing-indicator');
        const toggleBtn = document.getElementById('toggle-details-btn');
        const API_URL = 'http://127.0.0.1:5000/predict';

        // --- Event Listener for toggling the detailed form ---
        toggleBtn.addEventListener('click', () => {
            const form = document.getElementById('detailed-analysis-form');
            const isHidden = form.classList.contains('hidden');
            form.classList.toggle('hidden');
            toggleBtn.innerHTML = isHidden 
                ? 'Hide Transaction Details &#9652;' 
                : 'Enter Full Transaction Details for Hybrid Analysis &#9662;';
        });

        // --- Event Listener for the main CHATBOT form ---
        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;
            appendUserMessage(message, 'chat');
            chatInput.value = '';
            await sendRequest({ textMessage: message, amount: 0 }); // Explicitly set amount to 0 for NLP-only mode
        });

        // --- Event Listener for the DETAILED form ---
        detailedForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = {
                textMessage: document.getElementById('hybrid-text-message').value,
                step: document.getElementById('step').value,
                type: document.getElementById('type').value,
                amount: document.getElementById('amount').value,
                oldbalanceOrg: document.getElementById('oldbalanceOrg').value,
                newbalanceOrig: document.getElementById('newbalanceOrig').value,
                oldbalanceDest: document.getElementById('oldbalanceDest').value
            };
            appendUserMessage('Submitted full transaction details for analysis.', 'form');
            await sendRequest(formData);
        });

        async function sendRequest(data) {
            showTypingIndicator();
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'Server returned an invalid response'}));
                    throw new Error(errorData.error || `Network response was not ok. Status: ${response.status}`);
                }
                const result = await response.json();
                appendBotResponse(result);
            } catch (error) {
                console.error("Error calling backend:", error);
                appendErrorMessage(error.message || "Could not connect to the analysis service.");
            } finally {
                hideTypingIndicator();
            }
        }

        // --- UI Helper Functions ---
        function appendUserMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'user-message self-end max-w-md';
            const text = type === 'chat' ? escapeHTML(message) : `<i>${escapeHTML(message)}</i>`;
            messageDiv.innerHTML = `<div class="bg-blue-600 text-white rounded-lg p-3">${text}</div>`;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        function appendBotResponse(result) {
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'bot-message self-start max-w-md';
            const confidenceColor = result.isFraud ? 'red' : 'green';
            const riskLevel = result.isFraud ? 'High Risk' : 'Low Risk';
            const warningText = result.isFraud 
                ? '<strong>Warning:</strong> This transaction shows indicators of fraud.'
                : '<strong>Notice:</strong> This transaction appears to be legitimate.';
            botMessageDiv.innerHTML = `<div class="bg-gray-700 rounded-lg p-3 space-y-3"><p class="font-semibold text-${confidenceColor}-300">${warningText}</p><div><span class="text-xs font-medium text-gray-400">Analysis by: ${result.modelUsed}</span><div class="w-full bg-gray-600 rounded-full h-2.5 mt-1"><div class="h-2.5 rounded-full bg-gradient-to-r from-${confidenceColor}-500 to-${confidenceColor}-400" style="width: ${result.confidence}%"></div></div><p class="text-right text-sm font-semibold mt-1">Confidence (${riskLevel}): ${result.confidence}%</p></div></div>`;
            chatWindow.appendChild(botMessageDiv);
            scrollToBottom();
        }

        function appendErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bot-message self-start max-w-md';
            errorDiv.innerHTML = `<div class="bg-yellow-500/20 text-yellow-300 border border-yellow-500 rounded-lg p-3"><strong>Error:</strong> ${escapeHTML(message)}</div>`;
            chatWindow.appendChild(errorDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[match]));
        }
    </script>
</body>
</html>
